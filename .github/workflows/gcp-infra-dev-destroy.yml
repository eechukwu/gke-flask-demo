name: "GCP Infra - Dev - Destroy"

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type DESTROY to confirm'
        required: true
        type: string
      environment:
        description: 'Environment to destroy'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev

env:
  TF_VERSION: "1.7.0"
  WORKING_DIR: "infra/gcp/envs/dev"

permissions:
  contents: read

concurrency:
  group: gcp-infra-dev
  cancel-in-progress: false

jobs:
  destroy:
    name: "Terraform Destroy"
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'DESTROY' && github.event.inputs.environment == 'dev'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: GCP Auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        working-directory: ${{ env.WORKING_DIR }}
        run: terraform init -input=false

      - name: Terraform Plan Destroy
        working-directory: ${{ env.WORKING_DIR }}
        run: terraform plan -destroy -input=false -no-color -out=tfplan-destroy

      - name: Terraform Destroy
        working-directory: ${{ env.WORKING_DIR }}
        run: terraform apply -input=false -auto-approve tfplan-destroy
