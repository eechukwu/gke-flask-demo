name: Deploy to DEV

on:
  workflow_run:
    workflows: ["Build and Push Docker Image"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy-dev:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    env:
      PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      GKE_CLUSTER: ${{ secrets.GKE_CLUSTER_NAME }}
      GKE_ZONE: ${{ secrets.GKE_ZONE }}
      AR_REPO: "europe-west2-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/flask-repo"
      IMAGE_NAME: "flask-gke-demo"
      K8S_NAMESPACE: "dev"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: GCP login
        uses: ./.github/actions/gcp-login
        with:
          service-account-key: ${{ secrets.GCP_SA_KEY }}
          configure-docker: "false"

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials "$GKE_CLUSTER" --zone "$GKE_ZONE"

      - name: Apply Kubernetes manifests (dev)
        run: |
          # Ensure namespace exists
          kubectl apply -f k8s/namespace-dev.yaml

          # Core config & secrets
          kubectl apply -n "$K8S_NAMESPACE" -f k8s/configmap.yaml
          kubectl apply -n "$K8S_NAMESPACE" -f k8s/secret.yaml

          # Workloads
          kubectl apply -n "$K8S_NAMESPACE" -f k8s/deployment.yaml
          kubectl apply -n "$K8S_NAMESPACE" -f k8s/service.yaml

          # Autoscaling
          kubectl apply -n "$K8S_NAMESPACE" -f k8s/hpa.yaml
          kubectl apply -n "$K8S_NAMESPACE" -f k8s/vpa.yaml || echo "VPA apply failed â€“ continuing."

          # Network policies
          kubectl apply -n "$K8S_NAMESPACE" -f k8s/netpol-client-allowed.yaml
          kubectl apply -n "$K8S_NAMESPACE" -f k8s/netpol-client-blocked.yaml
          kubectl apply -n "$K8S_NAMESPACE" -f k8s/networkpolicy-flask-allow-app.yaml

          # RBAC (read-only role + test pod)
          kubectl apply -n "$K8S_NAMESPACE" -f k8s/rbac-readonly.yaml
          kubectl apply -n "$K8S_NAMESPACE" -f k8s/rbac-readonly-test-pod.yaml

      - name: Update deployment image (dev)
        run: |
          kubectl set image deployment/flask-gke-demo \
            flask-gke-demo="${AR_REPO}/${IMAGE_NAME}:latest" \
            -n "$K8S_NAMESPACE"

      - name: Check rollout status (dev)
        run: |
          kubectl rollout status deployment/flask-gke-demo -n "$K8S_NAMESPACE" --timeout=180s

          echo "Current pods in $K8S_NAMESPACE:"
          kubectl get pods -n "$K8S_NAMESPACE"

          echo "Current HPA in $K8S_NAMESPACE:"
          kubectl get hpa -n "$K8S_NAMESPACE" || echo "No HPA found"