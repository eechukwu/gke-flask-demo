apiVersion: apps/v1
kind: Deployment
metadata:
  name: flask-gke-demo
  labels:
    app: flask-gke-demo
spec:
  # We run 1 replica now (HPA will scale this up under load)
  replicas: 1

  # ðŸ” Explicit rolling update strategy for safer, zero-downtime deploys
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1        # allow 1 extra pod above desired during rollout
      maxUnavailable: 0  # never take a pod down until a new one is ready

  selector:
    matchLabels:
      app: flask-gke-demo
  template:
    metadata:
      labels:
        app: flask-gke-demo
    spec:
      containers:
        - name: flask-gke-demo
          # Base image reference; GitHub Actions will overwrite this with kubectl set image
          image: europe-west2-docker.pkg.dev/k8s-interview-lab/flask-repo/flask-gke-demo:latest
          imagePullPolicy: Always

          # The Flask app listens on port 8080
          ports:
            - containerPort: 8080

          # âœ… Load config + secrets as environment variables
          envFrom:
            - configMapRef:
                name: flask-config      # adjust if your ConfigMap has a different name
            - secretRef:
                name: flask-secret      # adjust if your Secret has a different name

          # âœ… Also mount the secret as files (for things like certs, keys)
          volumeMounts:
            - name: flask-secret-volume
              mountPath: /var/run/secrets/flask
              readOnly: true

          # K8s uses this to decide when the container is "alive" or needs a restart
          livenessProbe:
            httpGet:
              path: /healthz
              port: 8080
            initialDelaySeconds: 10    # wait 10s before first liveness check
            periodSeconds: 10          # check every 10s
            failureThreshold: 3        # 3 failed checks => restart the container

          # K8s uses this to decide when the pod is ready to receive traffic
          readinessProbe:
            httpGet:
              path: /healthz
              port: 8080
            initialDelaySeconds: 5     # become ready slightly sooner than liveness
            periodSeconds: 5
            failureThreshold: 3

          # Resource requests/limits for scheduling and protection
          resources:
            requests:
              cpu: "50m"       # reserve 0.05 vCPU
              memory: "64Mi"   # reserve 64MiB RAM
            limits:
              cpu: "100m"      # cap at 0.1 vCPU
              memory: "128Mi"  # cap at 128MiB RAM

      # ðŸ“¦ Define the secret volume (backed by the Secret)
      volumes:
        - name: flask-secret-volume
          secret:
            secretName: flask-secret     # must match the Secret name