# Part 6: Security Groups Deep Dive
## Understanding Network Security in Your Infrastructure

---

## ğŸ“‹ Table of Contents

| Section | Description |
|---------|-------------|
| [1. What Are Security Groups?](#1-what-are-security-groups) | Virtual firewalls explained |
| [2. Your 3 Security Groups](#2-your-3-security-groups) | Overview of all SGs |
| [3. Bastion Security Group](#3-bastion-security-group) | Detailed breakdown |
| [4. ALB Security Group](#4-alb-security-group) | Detailed breakdown |
| [5. App Security Group](#5-app-security-group) | Detailed breakdown |
| [6. Traffic Flow Matrix](#6-traffic-flow-matrix) | Who can talk to whom |
| [7. Defense in Depth](#7-defense-in-depth) | Layered security |
| [8. Security Group vs NACL](#8-security-group-vs-nacl) | Key differences |
| [9. Common Mistakes](#9-common-mistakes) | What to avoid |
| [10. Interview Questions](#10-interview-questions) | Key concepts |

---

## 1. What Are Security Groups?

### The Concept

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 SECURITY GROUP = VIRTUAL FIREWALL                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   A security group acts like a BOUNCER at a club:               â”‚
â”‚                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                                                          â”‚   â”‚
â”‚   â”‚         ğŸš¶ "I want to                                    â”‚   â”‚
â”‚   â”‚            SSH in"                                       â”‚   â”‚
â”‚   â”‚              â”‚                                           â”‚   â”‚
â”‚   â”‚              â–¼                                           â”‚   â”‚
â”‚   â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚   â”‚
â”‚   â”‚         â”‚  ğŸ§‘â€âœˆï¸        â”‚                                   â”‚   â”‚
â”‚   â”‚         â”‚  BOUNCER   â”‚  â—„â”€â”€ Security Group               â”‚   â”‚
â”‚   â”‚         â”‚  (SG)      â”‚                                   â”‚   â”‚
â”‚   â”‚         â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                   â”‚   â”‚
â”‚   â”‚               â”‚                                          â”‚   â”‚
â”‚   â”‚         â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”                                    â”‚   â”‚
â”‚   â”‚         â”‚ Checks    â”‚                                    â”‚   â”‚
â”‚   â”‚         â”‚ the list: â”‚                                    â”‚   â”‚
â”‚   â”‚         â”‚           â”‚                                    â”‚   â”‚
â”‚   â”‚         â”‚ SSH:22 âœ“  â”‚  "SSH is on the list,             â”‚   â”‚
â”‚   â”‚         â”‚ HTTP:80 âœ“ â”‚   you may enter"                  â”‚   â”‚
â”‚   â”‚         â”‚ FTP:21 âœ—  â”‚                                    â”‚   â”‚
â”‚   â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚   â”‚
â”‚   â”‚                                                          â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Key Characteristics

| Feature | Description |
|---------|-------------|
| **Stateful** | If traffic is allowed in, response is automatically allowed out |
| **Allow only** | You can only create ALLOW rules, not DENY rules |
| **Default deny** | All traffic is blocked unless explicitly allowed |
| **Instance level** | Attached to ENI (network interface) of instances |
| **Multiple SGs** | An instance can have multiple security groups |

### Stateful Explained

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 STATEFUL = REMEMBERS CONNECTIONS                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   SCENARIO: SSH into bastion                                    â”‚
â”‚                                                                  â”‚
â”‚   YOU                              BASTION                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚   â”‚ ğŸ‘¤      â”‚                     â”‚ ğŸ–¥ï¸      â”‚                   â”‚
â”‚   â”‚         â”‚   1. SSH request    â”‚         â”‚                   â”‚
â”‚   â”‚         â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  â”‚         â”‚                   â”‚
â”‚   â”‚         â”‚   Port 22           â”‚         â”‚                   â”‚
â”‚   â”‚         â”‚                     â”‚         â”‚                   â”‚
â”‚   â”‚         â”‚   Inbound rule:     â”‚         â”‚                   â”‚
â”‚   â”‚         â”‚   SSH:22 âœ“ ALLOW    â”‚         â”‚                   â”‚
â”‚   â”‚         â”‚                     â”‚         â”‚                   â”‚
â”‚   â”‚         â”‚                     â”‚         â”‚                   â”‚
â”‚   â”‚         â”‚   2. SSH response   â”‚         â”‚                   â”‚
â”‚   â”‚         â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚         â”‚                   â”‚
â”‚   â”‚         â”‚   Port 54321        â”‚         â”‚                   â”‚
â”‚   â”‚         â”‚   (random high)     â”‚         â”‚                   â”‚
â”‚   â”‚         â”‚                     â”‚         â”‚                   â”‚
â”‚   â”‚         â”‚   No egress rule    â”‚         â”‚                   â”‚
â”‚   â”‚         â”‚   for port 54321!   â”‚         â”‚                   â”‚
â”‚   â”‚         â”‚                     â”‚         â”‚                   â”‚
â”‚   â”‚         â”‚   BUT... SG is      â”‚         â”‚                   â”‚
â”‚   â”‚         â”‚   STATEFUL!         â”‚         â”‚                   â”‚
â”‚   â”‚         â”‚                     â”‚         â”‚                   â”‚
â”‚   â”‚         â”‚   It REMEMBERS      â”‚         â”‚                   â”‚
â”‚   â”‚         â”‚   the inbound       â”‚         â”‚                   â”‚
â”‚   â”‚         â”‚   connection,       â”‚         â”‚                   â”‚
â”‚   â”‚         â”‚   so response is    â”‚         â”‚                   â”‚
â”‚   â”‚         â”‚   automatically     â”‚         â”‚                   â”‚
â”‚   â”‚         â”‚   ALLOWED âœ“         â”‚         â”‚                   â”‚
â”‚   â”‚         â”‚                     â”‚         â”‚                   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. Your 3 Security Groups

### Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         YOUR 3 SECURITY GROUPS                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚  1ï¸âƒ£  BASTION_SG                                                           â”‚ â”‚
â”‚   â”‚      Name: devOps-interview-lab-dev-bastion-sg                            â”‚ â”‚
â”‚   â”‚      Attached to: Bastion EC2 instance                                    â”‚ â”‚
â”‚   â”‚                                                                            â”‚ â”‚
â”‚   â”‚      INBOUND:                        OUTBOUND:                            â”‚ â”‚
â”‚   â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚ â”‚
â”‚   â”‚      â”‚ SSH (22)  â† 0.0.0.0/0 â”‚     â”‚ ALL      â†’ 0.0.0.0/0  â”‚           â”‚ â”‚
â”‚   â”‚      â”‚ HTTP (80) â† 0.0.0.0/0 â”‚     â”‚                        â”‚           â”‚ â”‚
â”‚   â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚  2ï¸âƒ£  ALB_SG                                                               â”‚ â”‚
â”‚   â”‚      Name: devOps-interview-lab-dev-alb-sg                                â”‚ â”‚
â”‚   â”‚      Attached to: Application Load Balancer                               â”‚ â”‚
â”‚   â”‚                                                                            â”‚ â”‚
â”‚   â”‚      INBOUND:                        OUTBOUND:                            â”‚ â”‚
â”‚   â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚ â”‚
â”‚   â”‚      â”‚ HTTP (80) â† 0.0.0.0/0 â”‚     â”‚ ALL      â†’ 0.0.0.0/0  â”‚           â”‚ â”‚
â”‚   â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚  3ï¸âƒ£  APP_SG                                                               â”‚ â”‚
â”‚   â”‚      Name: devOps-interview-lab-dev-app-sg                                â”‚ â”‚
â”‚   â”‚      Attached to: App EC2 instances (via ASG)                             â”‚ â”‚
â”‚   â”‚                                                                            â”‚ â”‚
â”‚   â”‚      INBOUND:                        OUTBOUND:                            â”‚ â”‚
â”‚   â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚ â”‚
â”‚   â”‚      â”‚ HTTP (80) â† 10.10.0.0 â”‚     â”‚ ALL      â†’ 0.0.0.0/0  â”‚           â”‚ â”‚
â”‚   â”‚      â”‚            /16 (VPC)  â”‚     â”‚                        â”‚           â”‚ â”‚
â”‚   â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Comparison Table

| Security Group | Inbound | Outbound | Purpose |
|----------------|---------|----------|---------|
| **bastion_sg** | SSH:22, HTTP:80 from 0.0.0.0/0 | ALL to 0.0.0.0/0 | Admin access |
| **alb_sg** | HTTP:80 from 0.0.0.0/0 | ALL to 0.0.0.0/0 | Public web traffic |
| **app_sg** | HTTP:80 from 10.10.0.0/16 | ALL to 0.0.0.0/0 | Internal app traffic |

---

## 3. Bastion Security Group

### The Code

```hcl
resource "aws_security_group" "bastion_sg" {
  name        = "${var.project_name}-${var.environment}-bastion-sg"
  description = "Bastion SSH/HTTP access"
  vpc_id      = module.vpc.vpc_id

  # SSH access
  dynamic "ingress" {
    for_each = var.bastion_allowed_ssh_cidrs  # ["0.0.0.0/0"]
    content {
      description = "SSH from allowed CIDR"
      from_port   = 22
      to_port     = 22
      protocol    = "tcp"
      cidr_blocks = [ingress.value]
    }
  }

  # HTTP access (conditional)
  dynamic "ingress" {
    for_each = var.bastion_enable_http ? var.bastion_allowed_ssh_cidrs : []
    content {
      description = "HTTP from allowed CIDR"
      from_port   = 80
      to_port     = 80
      protocol    = "tcp"
      cidr_blocks = [ingress.value]
    }
  }

  # Outbound: allow all
  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
  }
}
```

### Visual Breakdown

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    BASTION SECURITY GROUP                        â”‚
â”‚              devOps-interview-lab-dev-bastion-sg                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚                          INTERNET                                â”‚
â”‚                         0.0.0.0/0                               â”‚
â”‚                             â”‚                                    â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚              â”‚              â”‚              â”‚                    â”‚
â”‚              â–¼              â–¼              â–¼                    â”‚
â”‚          SSH:22        HTTP:80       Other ports                â”‚
â”‚              â”‚              â”‚              â”‚                    â”‚
â”‚              â”‚              â”‚              â”‚                    â”‚
â”‚         â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”              â”‚
â”‚         â”‚ ALLOW   â”‚    â”‚ ALLOW   â”‚    â”‚ DENY    â”‚              â”‚
â”‚         â”‚ âœ…      â”‚    â”‚ âœ…      â”‚    â”‚ âŒ      â”‚              â”‚
â”‚         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚              â”‚              â”‚                                    â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚                     â”‚                                            â”‚
â”‚                     â–¼                                            â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â”‚
â”‚            â”‚     BASTION     â”‚                                  â”‚
â”‚            â”‚                 â”‚                                  â”‚
â”‚            â”‚  Can:           â”‚                                  â”‚
â”‚            â”‚  â€¢ Receive SSH  â”‚                                  â”‚
â”‚            â”‚  â€¢ Receive HTTP â”‚                                  â”‚
â”‚            â”‚  â€¢ Send ALL     â”‚                                  â”‚
â”‚            â”‚    (egress)     â”‚                                  â”‚
â”‚            â”‚                 â”‚                                  â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  â”‚
â”‚                     â”‚                                            â”‚
â”‚                     â”‚ EGRESS: ALL to 0.0.0.0/0                  â”‚
â”‚                     â”‚                                            â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚              â”‚             â”‚                                    â”‚
â”‚              â–¼             â–¼                                    â”‚
â”‚         App Servers    Internet                                 â”‚
â”‚         (SSH to them)  (yum update)                            â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Why These Rules?

| Rule | Purpose | Security Note |
|------|---------|---------------|
| SSH:22 from 0.0.0.0/0 | Admin access from anywhere | âš ï¸ Too open for prod - restrict to office IPs |
| HTTP:80 from 0.0.0.0/0 | Test nginx is running | Optional, for verification |
| ALL egress | Reach app servers, download updates | Standard practice |

---

## 4. ALB Security Group

### The Code

```hcl
resource "aws_security_group" "alb_sg" {
  name        = "${var.project_name}-${var.environment}-alb-sg"
  description = "ALB HTTP access from internet"
  vpc_id      = module.vpc.vpc_id

  ingress {
    description = "HTTP from internet"
    from_port   = 80
    to_port     = 80
    protocol    = "tcp"
    cidr_blocks = [var.allowed_http_cidr]  # "0.0.0.0/0"
  }

  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
  }
}
```

### Visual Breakdown

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ALB SECURITY GROUP                            â”‚
â”‚                devOps-interview-lab-dev-alb-sg                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚                          INTERNET                                â”‚
â”‚                         0.0.0.0/0                               â”‚
â”‚                             â”‚                                    â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚              â”‚              â”‚              â”‚                    â”‚
â”‚              â–¼              â–¼              â–¼                    â”‚
â”‚          HTTP:80       HTTPS:443     Other ports                â”‚
â”‚              â”‚              â”‚              â”‚                    â”‚
â”‚              â”‚              â”‚              â”‚                    â”‚
â”‚         â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”              â”‚
â”‚         â”‚ ALLOW   â”‚    â”‚ DENY    â”‚    â”‚ DENY    â”‚              â”‚
â”‚         â”‚ âœ…      â”‚    â”‚ âŒ      â”‚    â”‚ âŒ      â”‚              â”‚
â”‚         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚              â”‚                                                   â”‚
â”‚              â”‚  Only HTTP:80 gets through!                      â”‚
â”‚              â”‚                                                   â”‚
â”‚              â–¼                                                   â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                         â”‚
â”‚     â”‚       ALB       â”‚                                         â”‚
â”‚     â”‚                 â”‚                                         â”‚
â”‚     â”‚  Listener: :80  â”‚                                         â”‚
â”‚     â”‚  Action: forwardâ”‚                                         â”‚
â”‚     â”‚  to app_tg      â”‚                                         â”‚
â”‚     â”‚                 â”‚                                         â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                         â”‚
â”‚              â”‚                                                   â”‚
â”‚              â”‚ EGRESS: ALL to 0.0.0.0/0                         â”‚
â”‚              â”‚ (but only goes to app servers)                   â”‚
â”‚              â”‚                                                   â”‚
â”‚              â–¼                                                   â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                         â”‚
â”‚     â”‚  App Servers    â”‚                                         â”‚
â”‚     â”‚  10.10.30.x     â”‚                                         â”‚
â”‚     â”‚  10.10.40.x     â”‚                                         â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                         â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Production Considerations

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              PRODUCTION ALB SECURITY GROUP                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   YOUR CONFIG (Dev):                                            â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  ingress {                                               â”‚   â”‚
â”‚   â”‚    from_port   = 80                                      â”‚   â”‚
â”‚   â”‚    protocol    = "tcp"                                   â”‚   â”‚
â”‚   â”‚    cidr_blocks = ["0.0.0.0/0"]                          â”‚   â”‚
â”‚   â”‚  }                                                       â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚   âœ… Fine for dev/testing                                       â”‚
â”‚                                                                  â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                  â”‚
â”‚   PRODUCTION CONFIG:                                            â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  # HTTP â†’ redirect to HTTPS                             â”‚   â”‚
â”‚   â”‚  ingress {                                               â”‚   â”‚
â”‚   â”‚    from_port   = 80                                      â”‚   â”‚
â”‚   â”‚    protocol    = "tcp"                                   â”‚   â”‚
â”‚   â”‚    cidr_blocks = ["0.0.0.0/0"]                          â”‚   â”‚
â”‚   â”‚  }                                                       â”‚   â”‚
â”‚   â”‚                                                          â”‚   â”‚
â”‚   â”‚  # HTTPS (add SSL certificate!)                         â”‚   â”‚
â”‚   â”‚  ingress {                                               â”‚   â”‚
â”‚   â”‚    from_port   = 443                                     â”‚   â”‚
â”‚   â”‚    protocol    = "tcp"                                   â”‚   â”‚
â”‚   â”‚    cidr_blocks = ["0.0.0.0/0"]                          â”‚   â”‚
â”‚   â”‚  }                                                       â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚   âœ… Encrypted traffic in production                            â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. App Security Group

### The Code

```hcl
resource "aws_security_group" "app_sg" {
  name        = "${var.project_name}-${var.environment}-app-sg"
  description = "App EC2 instances - HTTP from VPC only"
  vpc_id      = module.vpc.vpc_id

  ingress {
    description = "HTTP from VPC"
    from_port   = 80
    to_port     = 80
    protocol    = "tcp"
    cidr_blocks = [module.vpc.vpc_cidr_block]  # 10.10.0.0/16
  }

  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
  }
}
```

### Visual Breakdown

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    APP SECURITY GROUP                            â”‚
â”‚                devOps-interview-lab-dev-app-sg                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   SOURCE CHECKING:                                              â”‚
â”‚                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚                                                            â”‚ â”‚
â”‚   â”‚   INTERNET               ALB              BASTION          â”‚ â”‚
â”‚   â”‚   (203.0.113.50)        (10.10.10.100)   (10.10.10.50)    â”‚ â”‚
â”‚   â”‚        â”‚                     â”‚                â”‚            â”‚ â”‚
â”‚   â”‚        â”‚                     â”‚                â”‚            â”‚ â”‚
â”‚   â”‚        â–¼                     â–¼                â–¼            â”‚ â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚ â”‚
â”‚   â”‚   â”‚ Is src  â”‚          â”‚ Is src  â”‚      â”‚ Is src  â”‚       â”‚ â”‚
â”‚   â”‚   â”‚ in VPC  â”‚          â”‚ in VPC  â”‚      â”‚ in VPC  â”‚       â”‚ â”‚
â”‚   â”‚   â”‚ CIDR?   â”‚          â”‚ CIDR?   â”‚      â”‚ CIDR?   â”‚       â”‚ â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜       â”‚ â”‚
â”‚   â”‚        â”‚                    â”‚                â”‚             â”‚ â”‚
â”‚   â”‚   203.0.113.50         10.10.10.100     10.10.10.50       â”‚ â”‚
â”‚   â”‚   in 10.10.0.0/16?     in 10.10.0.0/16? in 10.10.0.0/16? â”‚ â”‚
â”‚   â”‚        â”‚                    â”‚                â”‚             â”‚ â”‚
â”‚   â”‚        â–¼                    â–¼                â–¼             â”‚ â”‚
â”‚   â”‚      NO âŒ               YES âœ…           YES âœ…          â”‚ â”‚
â”‚   â”‚     BLOCKED              ALLOWED          ALLOWED         â”‚ â”‚
â”‚   â”‚                                                            â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                  â”‚
â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚                     â”‚   APP SERVER    â”‚                         â”‚
â”‚                     â”‚   10.10.30.15   â”‚                         â”‚
â”‚                     â”‚                 â”‚                         â”‚
â”‚                     â”‚  Accepts:       â”‚                         â”‚
â”‚                     â”‚  â€¢ ALB traffic  â”‚                         â”‚
â”‚                     â”‚  â€¢ Bastion (80) â”‚                         â”‚
â”‚                     â”‚                 â”‚                         â”‚
â”‚                     â”‚  Rejects:       â”‚                         â”‚
â”‚                     â”‚  â€¢ Internet     â”‚                         â”‚
â”‚                     â”‚    directly     â”‚                         â”‚
â”‚                     â”‚                 â”‚                         â”‚
â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                              â”‚                                   â”‚
â”‚                              â”‚ EGRESS: ALL to 0.0.0.0/0         â”‚
â”‚                              â”‚                                   â”‚
â”‚                              â–¼                                   â”‚
â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚                     â”‚   NAT Gateway   â”‚                         â”‚
â”‚                     â”‚   (for updates) â”‚                         â”‚
â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### The Key Security Feature

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              WHY VPC CIDR IS BRILLIANT                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   cidr_blocks = [module.vpc.vpc_cidr_block]  # 10.10.0.0/16    â”‚
â”‚                                                                  â”‚
â”‚   This means:                                                   â”‚
â”‚   "Only allow traffic from IP addresses within my VPC"         â”‚
â”‚                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                                                          â”‚   â”‚
â”‚   â”‚   ALLOWED SOURCES (within VPC):                         â”‚   â”‚
â”‚   â”‚                                                          â”‚   â”‚
â”‚   â”‚   â€¢ ALB          10.10.10.x    âœ…                       â”‚   â”‚
â”‚   â”‚   â€¢ ALB          10.10.20.x    âœ…                       â”‚   â”‚
â”‚   â”‚   â€¢ Bastion      10.10.10.x    âœ…                       â”‚   â”‚
â”‚   â”‚   â€¢ Other apps   10.10.30.x    âœ…                       â”‚   â”‚
â”‚   â”‚   â€¢ Future DB    10.10.40.x    âœ…                       â”‚   â”‚
â”‚   â”‚                                                          â”‚   â”‚
â”‚   â”‚   BLOCKED SOURCES (outside VPC):                        â”‚   â”‚
â”‚   â”‚                                                          â”‚   â”‚
â”‚   â”‚   â€¢ Hackers      Any public IP âŒ                       â”‚   â”‚
â”‚   â”‚   â€¢ Internet     Any public IP âŒ                       â”‚   â”‚
â”‚   â”‚   â€¢ Other VPCs   Different CIDR âŒ                      â”‚   â”‚
â”‚   â”‚                                                          â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                  â”‚
â”‚   EVEN IF someone knew the app server's private IP,            â”‚
â”‚   they couldn't reach it from the internet!                    â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. Traffic Flow Matrix

### Complete Traffic Matrix

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         TRAFFIC FLOW MATRIX                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚   FROM / TO        â”‚ INTERNET â”‚ BASTION â”‚   ALB   â”‚   APP   â”‚ NAT GW â”‚          â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”‚
â”‚   INTERNET         â”‚    -     â”‚ SSH,HTTPâ”‚  HTTP   â”‚   âŒ    â”‚   âŒ   â”‚          â”‚
â”‚                    â”‚          â”‚   âœ…    â”‚   âœ…    â”‚ blocked â”‚ blockedâ”‚          â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”‚
â”‚   BASTION          â”‚   ALL    â”‚    -    â”‚   âœ…    â”‚ HTTP:80 â”‚   âœ…   â”‚          â”‚
â”‚                    â”‚   âœ…     â”‚         â”‚         â”‚   âœ…    â”‚        â”‚          â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”‚
â”‚   ALB              â”‚   ALL    â”‚   âœ…    â”‚    -    â”‚ HTTP:80 â”‚   N/A  â”‚          â”‚
â”‚                    â”‚   âœ…     â”‚         â”‚         â”‚   âœ…    â”‚        â”‚          â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”‚
â”‚   APP              â”‚ via NAT  â”‚   âœ…    â”‚   âœ…    â”‚    -    â”‚   âœ…   â”‚          â”‚
â”‚                    â”‚   âœ…     â”‚         â”‚         â”‚         â”‚        â”‚          â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                                  â”‚
â”‚   LEGEND:                                                                       â”‚
â”‚   âœ… = Allowed (security group permits)                                         â”‚
â”‚   âŒ = Blocked (security group denies or no route)                              â”‚
â”‚   N/A = Not applicable                                                          â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Visual Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         COMPLETE TRAFFIC FLOWS                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚                              INTERNET                                            â”‚
â”‚                                  â”‚                                               â”‚
â”‚                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚                 â”‚                â”‚                â”‚                             â”‚
â”‚                 â–¼                â–¼                â–¼                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚   â”‚   SSH:22 âœ…     â”‚  â”‚   HTTP:80 âœ…    â”‚  â”‚  Direct to App  â”‚               â”‚
â”‚   â”‚   HTTP:80 âœ…    â”‚  â”‚                 â”‚  â”‚      âŒ         â”‚               â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚            â”‚                    â”‚                                               â”‚
â”‚            â–¼                    â–¼                                               â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚
â”‚   â”‚     BASTION     â”‚  â”‚       ALB       â”‚                                     â”‚
â”‚   â”‚   bastion_sg    â”‚  â”‚     alb_sg      â”‚                                     â”‚
â”‚   â”‚                 â”‚  â”‚                 â”‚                                     â”‚
â”‚   â”‚  Public Subnet  â”‚  â”‚  Public Subnet  â”‚                                     â”‚
â”‚   â”‚  10.10.10.x     â”‚  â”‚  10.10.10-20.x  â”‚                                     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                     â”‚
â”‚            â”‚                    â”‚                                               â”‚
â”‚            â”‚                    â”‚ HTTP:80                                       â”‚
â”‚            â”‚                    â”‚ Source: 10.10.x.x                             â”‚
â”‚            â”‚                    â”‚                                               â”‚
â”‚            â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                               â”‚
â”‚            â”‚    â”‚                                                               â”‚
â”‚            â–¼    â–¼                                                               â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                        APP SECURITY GROUP CHECK                          â”‚  â”‚
â”‚   â”‚                                                                          â”‚  â”‚
â”‚   â”‚   Rule: HTTP:80 from 10.10.0.0/16                                       â”‚  â”‚
â”‚   â”‚                                                                          â”‚  â”‚
â”‚   â”‚   Bastion (10.10.10.50) â†’ Port 80 â†’ âœ… Source in VPC CIDR              â”‚  â”‚
â”‚   â”‚   ALB     (10.10.10.100) â†’ Port 80 â†’ âœ… Source in VPC CIDR             â”‚  â”‚
â”‚   â”‚   Internet (203.0.113.x) â†’ Port 80 â†’ âŒ Source NOT in VPC CIDR         â”‚  â”‚
â”‚   â”‚                                                                          â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                    â”‚                                                            â”‚
â”‚                    â–¼                                                            â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                          APP SERVERS                                     â”‚  â”‚
â”‚   â”‚                           app_sg                                         â”‚  â”‚
â”‚   â”‚                                                                          â”‚  â”‚
â”‚   â”‚             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚  â”‚
â”‚   â”‚             â”‚    App 1     â”‚        â”‚    App 2     â”‚                    â”‚  â”‚
â”‚   â”‚             â”‚ 10.10.30.15  â”‚        â”‚ 10.10.40.22  â”‚                    â”‚  â”‚
â”‚   â”‚             â”‚Private Subnetâ”‚        â”‚Private Subnetâ”‚                    â”‚  â”‚
â”‚   â”‚             â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚  â”‚
â”‚   â”‚                    â”‚                       â”‚                             â”‚  â”‚
â”‚   â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚  â”‚
â”‚   â”‚                                â”‚                                         â”‚  â”‚
â”‚   â”‚                                â”‚ Egress: ALL to 0.0.0.0/0               â”‚  â”‚
â”‚   â”‚                                â”‚                                         â”‚  â”‚
â”‚   â”‚                                â–¼                                         â”‚  â”‚
â”‚   â”‚                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚  â”‚
â”‚   â”‚                       â”‚   NAT Gateway   â”‚                               â”‚  â”‚
â”‚   â”‚                       â”‚   (for outbound â”‚                               â”‚  â”‚
â”‚   â”‚                       â”‚    internet)    â”‚                               â”‚  â”‚
â”‚   â”‚                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚  â”‚
â”‚   â”‚                                                                          â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. Defense in Depth

### The Concept

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DEFENSE IN DEPTH                              â”‚
â”‚              "Multiple layers of security"                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   Like a castle with multiple walls:                            â”‚
â”‚                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                                                          â”‚   â”‚
â”‚   â”‚                    ğŸ˜ˆ ATTACKER                           â”‚   â”‚
â”‚   â”‚                         â”‚                                â”‚   â”‚
â”‚   â”‚                         â–¼                                â”‚   â”‚
â”‚   â”‚   LAYER 1: â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Public subnet   â”‚   â”‚
â”‚   â”‚            ALB Security Group                           â”‚   â”‚
â”‚   â”‚            (only HTTP:80)                               â”‚   â”‚
â”‚   â”‚                         â”‚                                â”‚   â”‚
â”‚   â”‚                         â–¼                                â”‚   â”‚
â”‚   â”‚   LAYER 2: â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Private subnet  â”‚   â”‚
â”‚   â”‚            No public IPs                                â”‚   â”‚
â”‚   â”‚            (can't be reached directly)                  â”‚   â”‚
â”‚   â”‚                         â”‚                                â”‚   â”‚
â”‚   â”‚                         â–¼                                â”‚   â”‚
â”‚   â”‚   LAYER 3: â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• App SG         â”‚   â”‚
â”‚   â”‚            Only VPC CIDR allowed                        â”‚   â”‚
â”‚   â”‚            (extra check even if they got in)           â”‚   â”‚
â”‚   â”‚                         â”‚                                â”‚   â”‚
â”‚   â”‚                         â–¼                                â”‚   â”‚
â”‚   â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚   â”‚
â”‚   â”‚                   â”‚   APP    â”‚                          â”‚   â”‚
â”‚   â”‚                   â”‚  SERVER  â”‚                          â”‚   â”‚
â”‚   â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚   â”‚
â”‚   â”‚                                                          â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                  â”‚
â”‚   Each layer must be breached to reach the app!                â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Your Security Layers

| Layer | Component | What It Protects Against |
|-------|-----------|-------------------------|
| **1** | ALB SG | Only allows HTTP:80, blocks all other ports |
| **2** | Private Subnets | No public IPs, no direct internet access |
| **3** | App SG (VPC CIDR) | Even if someone got into VPC, only allows VPC sources |
| **4** | NAT Gateway | Outbound only, blocks inbound from internet |

### Attack Scenarios

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ATTACK SCENARIOS                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   SCENARIO 1: Direct attack on App Server                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                                                          â”‚   â”‚
â”‚   â”‚   Attacker â†’ App Server (10.10.30.15)                   â”‚   â”‚
â”‚   â”‚                                                          â”‚   â”‚
â”‚   â”‚   âŒ BLOCKED: App server has no public IP               â”‚   â”‚
â”‚   â”‚   âŒ BLOCKED: App SG only allows VPC CIDR               â”‚   â”‚
â”‚   â”‚                                                          â”‚   â”‚
â”‚   â”‚   Result: Attack fails at LAYER 2 & 3                   â”‚   â”‚
â”‚   â”‚                                                          â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                  â”‚
â”‚   SCENARIO 2: Attack via ALB (valid path)                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                                                          â”‚   â”‚
â”‚   â”‚   Attacker â†’ ALB â†’ App Server                           â”‚   â”‚
â”‚   â”‚                                                          â”‚   â”‚
â”‚   â”‚   âœ… ALLOWED: This is the intended path                 â”‚   â”‚
â”‚   â”‚                                                          â”‚   â”‚
â”‚   â”‚   BUT: Attacker can only send HTTP requests             â”‚   â”‚
â”‚   â”‚        ALB only forwards valid HTTP                      â”‚   â”‚
â”‚   â”‚        Can't SSH, can't access other ports              â”‚   â”‚
â”‚   â”‚                                                          â”‚   â”‚
â”‚   â”‚   Mitigation: Use WAF, rate limiting, HTTPS             â”‚   â”‚
â”‚   â”‚                                                          â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                  â”‚
â”‚   SCENARIO 3: SSH attack on App Server                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                                                          â”‚   â”‚
â”‚   â”‚   Attacker â†’ App Server:22                              â”‚   â”‚
â”‚   â”‚                                                          â”‚   â”‚
â”‚   â”‚   âŒ BLOCKED: App SG only allows port 80                â”‚   â”‚
â”‚   â”‚   âŒ BLOCKED: No route to private subnet                â”‚   â”‚
â”‚   â”‚                                                          â”‚   â”‚
â”‚   â”‚   Even from INSIDE VPC (e.g., compromised bastion):    â”‚   â”‚
â”‚   â”‚   âŒ BLOCKED: App SG has no SSH rule!                   â”‚   â”‚
â”‚   â”‚                                                          â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 8. Security Group vs NACL

### Comparison

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SECURITY GROUP vs NACL                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚   â”‚        SECURITY GROUP           â”‚             NACL                 â”‚        â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”‚
â”‚   â”‚                                 â”‚                                  â”‚        â”‚
â”‚   â”‚  Level: Instance (ENI)          â”‚  Level: Subnet                  â”‚        â”‚
â”‚   â”‚                                 â”‚                                  â”‚        â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚        â”‚
â”‚   â”‚  â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚   â”‚  â”‚   SUBNET                â”‚    â”‚        â”‚
â”‚   â”‚  â”‚  SG â”‚ Instanceâ”‚ SG      â”‚   â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚        â”‚
â”‚   â”‚  â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚   â”‚  â”‚   â”‚                 â”‚   â”‚    â”‚        â”‚
â”‚   â”‚  â”‚                         â”‚   â”‚  â”‚NACL    Instances    NACLâ”‚    â”‚        â”‚
â”‚   â”‚  â”‚  Each instance has SG   â”‚   â”‚  â”‚   â”‚                 â”‚   â”‚    â”‚        â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚        â”‚
â”‚   â”‚                                 â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚        â”‚
â”‚   â”‚                                 â”‚                                  â”‚        â”‚
â”‚   â”‚  Stateful: YES                 â”‚  Stateful: NO                    â”‚        â”‚
â”‚   â”‚  (return traffic auto-allowed) â”‚  (must allow return explicitly) â”‚        â”‚
â”‚   â”‚                                 â”‚                                  â”‚        â”‚
â”‚   â”‚  Rules: ALLOW only             â”‚  Rules: ALLOW and DENY          â”‚        â”‚
â”‚   â”‚                                 â”‚                                  â”‚        â”‚
â”‚   â”‚  Default: DENY all             â”‚  Default: ALLOW all             â”‚        â”‚
â”‚   â”‚                                 â”‚  (in default NACL)              â”‚        â”‚
â”‚   â”‚                                 â”‚                                  â”‚        â”‚
â”‚   â”‚  Evaluation: All rules         â”‚  Evaluation: In order           â”‚        â”‚
â”‚   â”‚  checked                       â”‚  (first match wins)              â”‚        â”‚
â”‚   â”‚                                 â”‚                                  â”‚        â”‚
â”‚   â”‚  USE FOR: Instance-level       â”‚  USE FOR: Subnet-level          â”‚        â”‚
â”‚   â”‚  control (most common)         â”‚  blocking (backup defense)      â”‚        â”‚
â”‚   â”‚                                 â”‚                                  â”‚        â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                                  â”‚
â”‚   YOUR CONFIG: Uses only Security Groups (standard practice)                    â”‚
â”‚   NACLs are optional additional defense layer                                   â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### When to Use Each

| Scenario | Use Security Group | Use NACL |
|----------|-------------------|----------|
| Control traffic to specific instances | âœ… Yes | Not ideal |
| Block specific IP ranges (blacklist) | Can't deny | âœ… Yes |
| Allow specific ports to instances | âœ… Yes | Also works |
| Subnet-wide blocking | No | âœ… Yes |
| Simple management | âœ… Yes | More complex |

---

## 9. Common Mistakes

### Mistake 1: Too Open Security Groups

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              MISTAKE: 0.0.0.0/0 FOR EVERYTHING                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   âŒ BAD:                                                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  ingress {                                               â”‚   â”‚
â”‚   â”‚    from_port   = 0                                       â”‚   â”‚
â”‚   â”‚    to_port     = 65535                                   â”‚   â”‚
â”‚   â”‚    protocol    = "-1"                                    â”‚   â”‚
â”‚   â”‚    cidr_blocks = ["0.0.0.0/0"]  # ALL from ANYWHERE!    â”‚   â”‚
â”‚   â”‚  }                                                       â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚   Opens ALL ports to the ENTIRE internet!                       â”‚
â”‚                                                                  â”‚
â”‚   âœ… GOOD:                                                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  ingress {                                               â”‚   â”‚
â”‚   â”‚    from_port   = 80                                      â”‚   â”‚
â”‚   â”‚    to_port     = 80                                      â”‚   â”‚
â”‚   â”‚    protocol    = "tcp"                                   â”‚   â”‚
â”‚   â”‚    cidr_blocks = [module.vpc.vpc_cidr_block]            â”‚   â”‚
â”‚   â”‚  }                                                       â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚   Only HTTP, only from VPC!                                     â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Mistake 2: SSH Open to World (in Production)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              MISTAKE: SSH FROM 0.0.0.0/0 IN PROD                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   âŒ BAD (for production):                                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  bastion_allowed_ssh_cidrs = ["0.0.0.0/0"]              â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚   Anyone on internet can try to SSH!                            â”‚
â”‚                                                                  â”‚
â”‚   âœ… GOOD (for production):                                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  bastion_allowed_ssh_cidrs = [                          â”‚   â”‚
â”‚   â”‚    "203.0.113.0/24",   # Office IP range               â”‚   â”‚
â”‚   â”‚    "198.51.100.10/32"  # VPN server                    â”‚   â”‚
â”‚   â”‚  ]                                                       â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚   Only known IPs can attempt SSH                                â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Mistake 3: Forgetting Egress Rules

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              MISTAKE: NO EGRESS RULES                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   âš ï¸  If you don't specify ANY egress:                          â”‚
â”‚   AWS creates a default ALLOW ALL egress rule.                  â”‚
â”‚                                                                  â”‚
â”‚   âŒ PROBLEM: If you specify SOME egress rules,                 â”‚
â”‚   the default is REMOVED!                                       â”‚
â”‚                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  egress {                                                â”‚   â”‚
â”‚   â”‚    from_port   = 443                                     â”‚   â”‚
â”‚   â”‚    to_port     = 443                                     â”‚   â”‚
â”‚   â”‚    protocol    = "tcp"                                   â”‚   â”‚
â”‚   â”‚    cidr_blocks = ["0.0.0.0/0"]                          â”‚   â”‚
â”‚   â”‚  }                                                       â”‚   â”‚
â”‚   â”‚  # Forgot to add other ports...                         â”‚   â”‚
â”‚   â”‚  # Now ONLY 443 outbound works!                         â”‚   â”‚
â”‚   â”‚  # yum update fails (needs 80/443)                      â”‚   â”‚
â”‚   â”‚  # DNS fails (needs 53)                                 â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                  â”‚
â”‚   âœ… SOLUTION: Usually allow all egress unless you have        â”‚
â”‚   specific requirements to restrict it.                         â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Mistake 4: Security Group Reference Cycles

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              MISTAKE: CIRCULAR REFERENCES                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   âŒ BAD: Creates dependency cycle                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  resource "aws_security_group" "sg_a" {                  â”‚   â”‚
â”‚   â”‚    ingress {                                             â”‚   â”‚
â”‚   â”‚      security_groups = [aws_security_group.sg_b.id]     â”‚   â”‚
â”‚   â”‚    }                                                     â”‚   â”‚
â”‚   â”‚  }                                                       â”‚   â”‚
â”‚   â”‚                                                          â”‚   â”‚
â”‚   â”‚  resource "aws_security_group" "sg_b" {                  â”‚   â”‚
â”‚   â”‚    ingress {                                             â”‚   â”‚
â”‚   â”‚      security_groups = [aws_security_group.sg_a.id]     â”‚   â”‚
â”‚   â”‚    }                                                     â”‚   â”‚
â”‚   â”‚  }                                                       â”‚   â”‚
â”‚   â”‚  # Terraform error: cycle detected!                     â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                  â”‚
â”‚   âœ… SOLUTION: Use aws_security_group_rule as separate         â”‚
â”‚   resources to break the cycle.                                 â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 10. Interview Questions

### Q1: What's the difference between security groups and NACLs?

> **Security groups** are stateful (return traffic auto-allowed), operate at instance level, and only allow ALLOW rules. **NACLs** are stateless (must allow return traffic), operate at subnet level, and support both ALLOW and DENY rules. Security groups are the primary defense; NACLs are an optional additional layer.

### Q2: Why is the app security group restricted to VPC CIDR instead of 0.0.0.0/0?

> Defense in depth. Even though app servers are in private subnets with no public IPs, restricting to VPC CIDR adds another security layer. If an attacker somehow got access to the VPC, they'd still need to originate from a VPC IP address to reach the app servers.

### Q3: What happens if you have no rules in a security group?

> All inbound traffic is blocked (default deny). For outbound, if you don't specify ANY egress rules, AWS creates a default allow-all rule. If you specify at least one egress rule, the default is removed.

### Q4: Can you modify security group rules without recreating the resource?

> Yes! Security group rules can be added, modified, or removed without recreating the security group. Changes take effect almost immediately (within seconds).

### Q5: What does "stateful" mean for security groups?

> If you allow inbound traffic (e.g., SSH on port 22), the response traffic is automatically allowed outbound, regardless of outbound rules. The security group "remembers" the connection. NACLs are stateless and don't have this feature.

### Q6: Why do ALB and Bastion have 0.0.0.0/0 for inbound but App doesn't?

> ALB and Bastion need to be accessible from the internet (that's their purpose). App servers should only be reached through the ALB or from within the VPC, so they use VPC CIDR to limit exposure.

### Q7: Can an instance have multiple security groups?

> Yes! An instance can have up to 5 security groups. Rules from all groups are combined (union). If any security group allows the traffic, it's allowed.

### Q8: What's the difference between `cidr_blocks` and `security_groups` in a rule?

> `cidr_blocks` allows traffic from IP ranges. `security_groups` allows traffic from instances that have a specific security group attached. Using security groups is more dynamic (if IPs change, rules still work).

### Q9: How would you restrict SSH to only your office IP?

> Change `bastion_allowed_ssh_cidrs` from `["0.0.0.0/0"]` to `["YOUR.OFFICE.IP.0/24"]` or `["SPECIFIC.IP/32"]` for a single IP.

### Q10: Why does every security group have "allow all" egress?

> Instances typically need to reach the internet (for updates, APIs) and other services. Restricting egress is possible but requires careful planning to not break functionality. For most use cases, allowing all egress and controlling inbound is sufficient.

---

## âœ… Part 6 Complete!

**Next: [Part 7 - Complete Architecture](./Part7-Complete-Architecture.md)**

Covers:
- Full architecture diagram
- End-to-end request flow
- Terraform dependency graph
- Outputs and how to use them
- Summary of all resources